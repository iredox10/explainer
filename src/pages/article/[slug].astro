---
import { serverStoryService } from "../../lib/server-appwrite.js";
import ScrollyTemplate from "../../components/templates/ScrollyTemplate.astro";
import StandardTemplate from "../../components/templates/StandardTemplate.astro";
import { VOX_HOME_DATA } from "../../data/mock";

export const prerender = false;

const { slug } = Astro.params;
let story;

try {
  story = await serverStoryService.getStoryBySlug(slug);
} catch (e) {
  console.error(`[ARTICLE] Failed to fetch story for slug ${slug}:`, e);
}

// Fallback to mock data for essential pages if DB fetch fails or is empty
if (!story) {
  if (slug === "giant-wakes")
    story = { ...VOX_HOME_DATA.hero, layout: "scrolly", scrollySections: [] };
  if (slug === "fiber-optic-lagos") story = VOX_HOME_DATA.latest[0];
}

if (!story) {
  return Astro.redirect("/404");
}

// Popularity Engine: Increment View Count
if (story.$id) {
  (serverStoryService as any).incrementViewCount(story.$id, story.viewCount);
}
---

{
  story.layout === "scrolly" ? (
    <ScrollyTemplate story={story} />
  ) : (
    <StandardTemplate story={story} />
  )
}
