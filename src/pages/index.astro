---
import MainLayout from "../layouts/MainLayout.astro";
import HeroFeature from "../components/ui/HeroFeature.astro";
import StreamCard from "../components/ui/StreamCard.astro";
import VideoSection from "../components/ui/VideoSection.astro";
import Footer from "../components/Footer.astro";
import { storyService } from "../lib/services";
import { VOX_HOME_DATA } from "../data/mock";

// Fetch Published Stories
const publishedStories = await storyService.getPublishedStories();

// Logic to determine which stories go where
// 1. Hero: Use the latest 'Featured' story, then 'Super Feature', or just the newest story
const heroStory = publishedStories.find(s => s.isFeatured) || 
                  publishedStories.find(s => s.category === 'Super Feature') || 
                  publishedStories[0] || 
                  VOX_HOME_DATA.hero;

// 2. Latest: Top 4 excluding the hero
const latestStories = publishedStories.length > 0 
    ? publishedStories.filter(s => s.$id !== heroStory.$id).slice(0, 4)
    : VOX_HOME_DATA.latest;

// 3. Politics & Culture (Filtered from live data or fallback)
const politicsStories = publishedStories.filter(s => s.category === 'Politics').slice(0, 3);
const displayPolitics = politicsStories.length > 0 ? politicsStories : VOX_HOME_DATA.politics;

const cultureStories = publishedStories.filter(s => s.category === 'Culture').slice(0, 4);
const displayCulture = cultureStories.length > 0 ? cultureStories : VOX_HOME_DATA.culture;

const trending = [
  "The case for abolishing the penny",
  "Why everyone is playing this word game",
  "How to sleep better",
  "The future of electric planes",
  "Why coffee is getting more expensive"
];
---

<MainLayout title="Explainer - Visual Journalism That Makes Sense of the World">
  
  <main class="max-w-7xl mx-auto px-6 py-12">
    
    <HeroFeature article={heroStory} />

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 mt-24 border-b border-gray-100 pb-24">
      <div class="hidden lg:block lg:col-span-3">
        <div class="sticky top-32">
          <h2 class="text-[10px] font-black uppercase tracking-[0.25em] mb-10 text-gray-400 border-b border-gray-100 pb-2">Trending Now</h2>
          <div class="space-y-10">
            {trending.map((item, i) => (
              <div class="group cursor-pointer">
                <div class="text-5xl font-serif-display font-black text-gray-100 group-hover:text-[#FAFF00] transition-colors leading-none mb-2">0{i + 1}</div>
                <a href="#" class="text-lg font-bold leading-tight text-black group-hover:text-gray-600 transition-colors block">{item}</a>
              </div>
            ))}
          </div>
        </div>
      </div>

      <div class="lg:col-span-9 lg:pl-12">
        <div class="flex items-end justify-between mb-12">
           <h2 class="text-6xl md:text-7xl font-serif-display font-black text-black tracking-tighter">Latest</h2>
           <div class="hidden md:block h-px flex-1 bg-gray-200 ml-8 mb-4"></div>
        </div>
        <div class="flex flex-col">
          {latestStories.map((article) => (
            <StreamCard article={article} />
          ))}
        </div>
      </div>
    </div>

    <section class="py-24 my-12 border-b border-gray-100">
        <div class="bg-[#FAFF00] p-12 md:p-20 relative overflow-hidden rounded-sm shadow-2xl">
            <div class="absolute -top-20 -right-20 w-64 h-64 bg-white/20 rounded-full blur-3xl"></div>
            <div class="relative z-10 grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
                <div>
                    <h2 class="font-serif-display font-black text-5xl md:text-6xl leading-[0.9] text-black mb-6">Understand the news, for real.</h2>
                    <p class="text-xl font-medium text-black/70 max-w-md">Our weekly newsletter breaks down the biggest stories into clear, actionable insights.</p>
                </div>
                <form class="flex flex-col sm:flex-row gap-3">
                    <input type="email" placeholder="you@work.com" class="flex-1 bg-white border-2 border-black/10 px-6 py-4 font-bold text-black focus:outline-none focus:border-black" />
                    <button class="bg-black text-white px-10 py-4 font-black uppercase tracking-widest text-sm hover:scale-105 transition-transform">Sign Me Up</button>
                </form>
            </div>
        </div>
    </section>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-16 py-24">
        <div>
            <div class="flex items-center gap-4 mb-12">
                <h3 class="text-4xl font-serif-display font-black text-black">Politics</h3>
                <span class="h-px flex-1 bg-blue-100"></span>
                <a href="/topic/politics" class="text-[10px] font-black uppercase tracking-widest text-blue-600 hover:underline">View Section →</a>
            </div>
            <div class="space-y-12">
                {displayPolitics.map((s, i) => (
                    <article class={`group ${i === 0 ? '' : 'flex gap-6 items-start border-t border-gray-100 pt-8'}`}>
                        {i === 0 ? (
                            <>
                                <div class="aspect-video overflow-hidden mb-6 bg-gray-100 relative">
                                    <img src={s.imageUrl || s.heroImage} class="w-full h-full object-cover grayscale-[50%] group-hover:grayscale-0 transition-all duration-700" />
                                </div>
                                <h4 class="text-3xl font-serif-display font-bold leading-tight group-hover:underline decoration-blue-400 underline-offset-4">
                                    <a href={s.slug ? `/article/${s.slug}` : '#'}>{s.headline || s.title}</a>
                                </h4>
                            </>
                        ) : (
                            <h4 class="text-xl font-serif-display font-bold leading-tight group-hover:text-blue-600 transition-colors">
                                <a href={s.slug ? `/article/${s.slug}` : '#'}>{s.headline || s.title}</a>
                            </h4>
                        )}
                    </article>
                ))}
            </div>
        </div>

        <div>
            <div class="flex items-center gap-4 mb-12">
                <h3 class="text-4xl font-serif-display font-black text-black">Culture</h3>
                <span class="h-px flex-1 bg-pink-100"></span>
                <a href="/topic/culture" class="text-[10px] font-black uppercase tracking-widest text-pink-600 hover:underline">View Section →</a>
            </div>
            <div class="space-y-12">
                {displayCulture.map((s, i) => (
                    <article class={`group ${i === 0 ? '' : 'flex gap-6 items-start border-t border-gray-100 pt-8'}`}>
                        {i === 0 ? (
                            <>
                                <div class="aspect-video overflow-hidden mb-6 bg-gray-100 relative">
                                    <img src={s.imageUrl || s.heroImage} class="w-full h-full object-cover grayscale-[50%] group-hover:grayscale-0 transition-all duration-700" />
                                </div>
                                <h4 class="text-3xl font-serif-display font-bold leading-tight group-hover:underline decoration-pink-400 underline-offset-4">
                                    <a href={s.slug ? `/article/${s.slug}` : '#'}>{s.headline || s.title}</a>
                                </h4>
                            </>
                        ) : (
                            <h4 class="text-xl font-serif-display font-bold leading-tight group-hover:text-pink-600 transition-colors">
                                <a href={s.slug ? `/article/${s.slug}` : '#'}>{s.headline || s.title}</a>
                            </h4>
                        )}
                    </article>
                ))}
            </div>
        </div>
    </div>
  </main>

  <VideoSection videos={VOX_HOME_DATA.videos} />
  <Footer />
</MainLayout>
