---
import MainLayout from "../layouts/MainLayout.astro";
import HeroFeature from "../components/ui/HeroFeature.astro";
import StreamCard from "../components/ui/StreamCard.astro";
import VideoSection from "../components/ui/VideoSection.astro";
import Footer from "../components/Footer.astro";
import NewsletterForm from "../components/ui/NewsletterForm.jsx";
import { serverStoryService } from "../lib/server-appwrite.js";
import { VOX_HOME_DATA } from "../data/mock";

// Types/Interfaces for data consistency
interface CleanArticle {
    $id?: string;
    headline?: string;
    title?: string;
    subhead?: string;
    author?: string;
    imageUrl?: string;
    heroImage?: string;
    category?: string;
    slug?: string;
    readTime?: string;
    isFeatured?: boolean;
    videoUrl?: string;
}

// Fetch Published Stories with absolute fail-safe
let publishedStories: CleanArticle[] = [];
let fetchError = false;

try {
    const rawStories = await serverStoryService.getPublishedStories();
    publishedStories = (rawStories || []) as CleanArticle[];
    
    if (publishedStories.length === 0) {
        console.warn(`[HOME] Appwrite (${import.meta.env.PUBLIC_APPWRITE_DATABASE_ID || 'vox_cms'}) returned 0 published stories. Check status field values.`);
    } else {
        console.log(`[HOME] successfully loaded ${publishedStories.length} stories from Appwrite.`);
    }
} catch (e: any) {
    fetchError = true;
    console.error("[HOME] Failed to fetch stories from Appwrite:", e.message);
}

// Logic to determine which stories go where
// 1. Hero: Use the latest 'Featured' story, then 'Super Feature', or just the newest story
const liveHero = publishedStories.find((s) => s.isFeatured === true) ||
                 publishedStories.find((s) => s.category === "Super Feature") ||
                 publishedStories[0];

const heroStory = liveHero || (VOX_HOME_DATA.hero as CleanArticle);

// 2. Latest: Top 4 excluding the hero
const latestStories =
    publishedStories.length > 0
        ? publishedStories
              .filter((s) => s.$id && s.$id !== heroStory?.$id)
              .slice(0, 4)
        : (VOX_HOME_DATA.latest as CleanArticle[]);

// 3. Dynamic Sections (Grouped by Category)
const categoriesWithStories = publishedStories.reduce((acc: any, story) => {
    const cat = story.category || "General";
    if (!acc[cat]) acc[cat] = [];
    acc[cat].push(story);
    return acc;
}, {});

const sortedCategories = Object.keys(categoriesWithStories).sort(
    (a, b) => categoriesWithStories[b].length - categoriesWithStories[a].length
);

// Trending: Use any featured stories or just the latest 5
const trending = (publishedStories.length > 0 
    ? publishedStories.slice(0, 5).map(s => s.headline || s.title)
    : [
    "The case for abolishing the penny",
    "Why everyone is playing this word game",
    "How to sleep better",
    "The future of electric planes",
    "Why coffee is getting more expensive",
]) as string[];

// Videos: Filter stories that have videoUrl
const liveVideos = publishedStories
    .filter(s => s.videoUrl)
    .map(s => ({
        title: s.headline || s.title,
        seriesName: s.category,
        duration: "Live",
        thumbUrl: s.heroImage || s.imageUrl
    }));

const displayVideos = liveVideos.length > 0 ? liveVideos : VOX_HOME_DATA.videos;
---

<MainLayout title="Explainer - Visual Journalism That Makes Sense of the World">
    <main class="max-w-7xl mx-auto px-6 py-12">
        <!-- Live Data Sync Debug (Hidden) -->
        <div style="display:none" data-appwrite-sync-status={publishedStories.length} data-fetch-error={fetchError}></div>

        <HeroFeature article={heroStory as any} />

        <div
            class="grid grid-cols-1 lg:grid-cols-12 gap-12 mt-24 border-b border-gray-100 pb-24"
        >
            <div class="hidden lg:block lg:col-span-3">
                <div class="sticky top-32">
                    <h2
                        class="text-[10px] font-black uppercase tracking-[0.25em] mb-10 text-gray-400 border-b border-gray-100 pb-2"
                    >
                        Trending Now
                    </h2>
                    <div class="space-y-10">
                        {
                            trending.map((item, i) => (
                                <div class="group cursor-pointer">
                                    <div class="text-5xl font-serif-display font-black text-black/10 group-hover:text-[#FAFF00] transition-colors leading-none mb-2">
                                        0{i + 1}
                                    </div>
                                    <div
                                        class="text-lg font-bold leading-tight text-black group-hover:text-gray-600 transition-colors block"
                                    >
                                        {item}
                                    </div>
                                </div>
                            ))
                        }
                    </div>
                </div>
            </div>

            <div class="lg:col-span-9 lg:pl-12">
                <div class="flex items-end justify-between mb-12">
                    <h2
                        class="text-6xl md:text-7xl font-serif-display font-black text-black tracking-tighter"
                    >
                        Latest
                    </h2>
                    <div
                        class="hidden md:block h-px flex-1 bg-gray-200 ml-8 mb-4"
                    >
                    </div>
                </div>
                <div class="flex flex-col">
                    {
                        latestStories.length > 0 ? (
                            latestStories.map((article) => (
                                <StreamCard article={article as any} />
                            ))
                        ) : (
                            <p class="text-gray-400 italic">No live stories found. Check your Appwrite connection.</p>
                        )
                    }
                </div>
            </div>
        </div>

        <section class="py-24 my-12 border-b border-gray-100">
            <div
                class="bg-[#FAFF00] p-12 md:p-20 relative overflow-hidden rounded-sm shadow-2xl"
            >
                <div
                    class="absolute -top-20 -right-20 w-64 h-64 bg-white/20 rounded-full blur-3xl"
                >
                </div>
                <div
                    class="relative z-10 grid grid-cols-1 lg:grid-cols-2 gap-12 items-center"
                >
                    <div>
                        <h2
                            class="font-serif-display font-black text-5xl md:text-6xl leading-[0.9] text-black mb-6"
                        >
                            Understand the news, for real.
                        </h2>
                        <p class="text-xl font-medium text-black/70 max-w-md">
                            Our weekly newsletter breaks down the biggest
                            stories into clear, actionable insights.
                        </p>
                    </div>
                    <div class="flex-1">
                        <NewsletterForm client:only="react" />
                    </div>
                </div>
            </div>
        </section>

        {/* Dynamic Sections Based on Live Categories */}
        <div class="space-y-24 py-24">
            {
                sortedCategories.slice(0, 3).map(catName => (
                    <div>
                        <div class="flex items-center gap-4 mb-12">
                            <h3 class="text-4xl font-serif-display font-black text-black uppercase tracking-tighter">
                                {catName}
                            </h3>
                            <span class="h-px flex-1 bg-gray-100"></span>
                            <a
                                href={`/topic/${catName.toLowerCase()}`}
                                class="text-[10px] font-black uppercase tracking-widest text-black hover:bg-[#FAFF00] px-3 py-1 rounded transition-all"
                                >Explore {catName} â†’</a
                            >
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
                            {
                                categoriesWithStories[catName].slice(0, 3).map((s: any, i: number) => (
                                    <article class="group">
                                        <div class="aspect-[16/10] overflow-hidden mb-6 bg-gray-100 relative rounded-sm">
                                            <img
                                                src={s.heroImage || s.imageUrl || 'https://images.unsplash.com/photo-1585829365294-111320e7588e?w=800&q=80'}
                                                class="w-full h-full object-cover grayscale-[50%] group-hover:grayscale-0 transition-all duration-700 scale-105 group-hover:scale-100"
                                            />
                                        </div>
                                        <h4 class="text-2xl font-serif-display font-bold leading-tight group-hover:underline decoration-[#FAFF00] decoration-4 underline-offset-4">
                                            <a href={`/article/${s.slug}`}>
                                                {s.headline || s.title}
                                            </a>
                                        </h4>
                                        <p class="text-xs text-gray-400 font-bold uppercase tracking-widest mt-4">By {s.author}</p>
                                    </article>
                                ))
                            }
                        </div>
                    </div>
                ))
            }
        </div>
    </main>

    <VideoSection videos={displayVideos as any} />
    <Footer />
</MainLayout>
