---
import MainLayout from "../../layouts/MainLayout.astro";
import VoxNav from "../../components/ui/VoxNav.astro";
import HeroLoop from "../../components/HeroLoop.astro";
import ScrollyIsland from "../../components/ScrollyIsland.jsx";
import ProgressBar from "../../components/ui/ProgressBar.jsx";
import BeforeAfter from "../../components/ui/BeforeAfter.jsx";
import ShareButtons from "../../components/ui/ShareButtons.jsx";
import PersistentAudioPlayer from "../../components/ui/PersistentAudioPlayer.jsx";
import Timeline from "../../components/ui/Timeline.jsx";
const TimelineComponent = /** @type {any} */ (Timeline);
import { Bookmark } from "lucide-react";
import { Image } from "astro:assets";

const { story } = Astro.props;

// Helper to parse JSON safely
const parseJSON = (data: any, fallback = []) => {
  if (!data) return fallback;
  if (typeof data !== "string") return data;
  try {
    return JSON.parse(data);
  } catch (e) {
    console.error("JSON Parse Error", e);
    return fallback;
  }
};

const blocks = parseJSON(story.content);

// Pre-process blocks to group standard content vs scrolly content
const contentGroups: any[] = [];
let currentStandardBlocks: any[] = [];

if (Array.isArray(blocks)) {
  blocks.forEach((block: any) => {
    if (block.type === "scrolly-group") {
      if (currentStandardBlocks.length > 0) {
        contentGroups.push({ type: "standard", blocks: currentStandardBlocks });
        currentStandardBlocks = [];
      }
      contentGroups.push({ type: "scrolly", data: block });
    } else {
      currentStandardBlocks.push(block);
    }
  });
}

if (currentStandardBlocks.length > 0) {
  contentGroups.push({ type: "standard", blocks: currentStandardBlocks });
}

const stripHtml = (value: any) => {
  if (!value) return "";
  if (typeof value !== "string") return String(value);
  return value.replace(/<[^>]+>/g, "").replace(/\s+/g, " ").trim();
};

const fullText = blocks
  .filter((b: any) => b.type === "p" || b.type === "heading" || b.type === "quote" || b.type === "callout")
  .map((b: any) => stripHtml(b.text))
  .join(". ");

import { serverStoryService } from "../../lib/server-appwrite.js";
const readTime = serverStoryService.calculateReadTime(blocks);
---

<MainLayout title={story.headline} showNav={false}>
  <ProgressBar client:load />
  <VoxNav />
  <HeroLoop
    headline={story.headline}
    subhead={story.subhead}
    videoUrl={story.videoUrl}
  />

  {
    contentGroups.map((group: any, groupIndex: number) => {
      if (group.type === "scrolly") {
        return (
          <ScrollyIsland
            client:only="react"
            steps={group.data.steps}
            id={`scrolly-${groupIndex}`}
          />
        );
      }

      return (
        <div class="max-w-7xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-12 gap-12">
          {/* Left Sidebar: Social Sticky */}
          <aside class="hidden lg:block lg:col-span-2">
            <div class="sticky top-32 flex flex-col gap-6 items-start py-12">
              <span class="text-[10px] font-black uppercase tracking-widest text-gray-400">
                Share
              </span>
              <ShareButtons client:load title={story.headline} />
            </div>
          </aside>

          {/* Mobile Share Bar */}
          <div class="lg:hidden flex items-center justify-between py-6 border-b border-gray-100">
            <div class="flex items-center gap-3">
              <span class="text-[9px] font-black uppercase tracking-widest text-gray-400">
                Share
              </span>
              <ShareButtons client:load title={story.headline} />
            </div>
            <button class="flex items-center gap-2 text-[9px] font-black uppercase tracking-widest text-gray-400 bg-gray-50 px-3 py-1.5 rounded-full border border-gray-100">
              <Bookmark className="w-3 h-3" />
              Save
            </button>
          </div>

          <section class="lg:col-span-8 lg:col-start-3 py-12 md:py-24 text-xl md:text-2xl font-serif leading-relaxed text-gray-900">
            {group.blocks.map((block: any) => {
              if (block.type === "p") {
                return <p class="mb-8"><Fragment set:html={block.text} /></p>;
              }
              if (block.type === "heading") {
                return (
                  <h2 class="font-sans font-black text-3xl md:text-4xl text-black mt-16 mb-8 tracking-tight leading-none italic border-l-4 border-[#FAFF00] pl-6">
                    <Fragment set:html={block.text} />
                  </h2>
                );
              }
              if (block.type === "quote") {
                return (
                  <blockquote class="my-12 border-l-4 border-gray-100 pl-8 font-serif text-3xl italic text-gray-500">
                    <Fragment set:html={block.text} />
                    {block.author && (
                      <cite class="block text-xs font-black uppercase tracking-widest text-gray-400 mt-4 not-italic">
                        â€” {block.author}
                      </cite>
                    )}
                  </blockquote>
                );
              }
              if (block.type === "image") {
                return (
                  <figure class="my-12">
                    <Image
                      src={block.url}
                      alt={block.caption || "Story Image"}
                      width={1200}
                      height={800}
                      class="w-full h-auto rounded-3xl shadow-xl"
                    />
                    {block.caption && (
                      <figcaption class="mt-4 text-xs font-bold text-gray-400 text-center uppercase tracking-widest">
                        {block.caption}
                      </figcaption>
                    )}
                  </figure>
                );
              }
              if (block.type === "video") {
                return (
                  <figure class="my-12">
                    <video
                      src={block.url}
                      class="w-full h-auto rounded-3xl shadow-xl"
                      controls={!block.autoplay}
                      autoplay={block.autoplay}
                      loop={block.loop}
                      muted={block.muted}
                      playsinline
                    />
                    {block.caption && (
                      <figcaption class="mt-4 text-xs font-bold text-gray-400 text-center uppercase tracking-widest">
                        {block.caption}
                      </figcaption>
                    )}
                  </figure>
                );
              }
              if (block.type === "beforeAfter") {
                return (
                  <BeforeAfter
                    client:visible
                    leftImage={block.leftImage}
                    rightImage={block.rightImage}
                    leftLabel={block.leftLabel}
                    rightLabel={block.rightLabel}
                    caption={block.caption}
                    displayMode={block.displayMode}
                  />
                );
              }
              if (block.type === "callout") {
                return (
                  <div class="bg-gray-50 p-8 rounded-3xl border border-gray-100 my-12">
                    <h4 class="text-[10px] font-black uppercase tracking-[0.2em] text-[#FAFF00] mb-3">
                      {block.title || "Context"}
                    </h4>
                    <p class="text-xl font-bold text-black leading-tight">
                      <Fragment set:html={block.text} />
                    </p>
                  </div>
                );
              }
              if (block.type === "timeline") {
                return (
                  <div class="my-12 bg-gray-50 border border-gray-100 rounded-3xl">
                    <TimelineComponent
                      client:only="react"
                      label={block.label}
                      highlight={block.highlight}
                      steps={block.timelineSteps || []}
                      variant={block.style || 'track'}
                      animated={false}
                      showContextLabel={false}
                      hud={false}
                    />
                  </div>
                );
              }
              return null;
            })}
          </section>
        </div>
      );
    })
  }

  <PersistentAudioPlayer client:load text={fullText} title={story.headline} />
</MainLayout>
