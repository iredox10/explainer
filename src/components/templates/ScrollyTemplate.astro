---
import MainLayout from "../../layouts/MainLayout.astro";
import VoxNav from "../../components/ui/VoxNav.astro";
import HeroLoop from "../../components/HeroLoop.astro";
import Highlighter from "../../components/Highlighter.jsx";
import ScrollyIsland from "../../components/ScrollyIsland.jsx";
import ProgressBar from "../../components/ui/ProgressBar.jsx";

import ShareButtons from "../../components/ui/ShareButtons.jsx";
import PersistentAudioPlayer from "../../components/ui/PersistentAudioPlayer.jsx";
import MultimediaEmbed from "../../components/ui/MultimediaEmbed.astro";
import { Bookmark, Clock, Calendar, CheckSquare } from "lucide-react";

const { story } = Astro.props;

// Helper to parse JSON safely
const parseJSON = (data: any, fallback = []) => {
  if (!data) return fallback;
  if (typeof data !== "string") return data;
  try {
    return JSON.parse(data);
  } catch (e) {
    console.error("JSON Parse Error", e);
    return fallback;
  }
};

const blocks = parseJSON(story.content);
const steps = parseJSON(story.scrollySections);
const fullText = blocks
  .filter((b: any) => b.type === "p" || b.type === "heading")
  .map((b: any) => b.text)
  .join(". ");

import { serverStoryService } from "../../lib/server-appwrite.js";
const readTime = serverStoryService.calculateReadTime(blocks);
const displayReadTime = `${readTime} min read`;
---

<MainLayout title={story.headline} showNav={false}>
  <div class="bg-white dark:bg-gray-900 transition-colors duration-300">
    <ProgressBar client:load />
    <VoxNav />
    <HeroLoop
      headline={story.headline}
      subhead={story.subhead}
      videoUrl={story.videoUrl}
    />

    <div class="max-w-7xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-12 gap-12">
      {/* Left Sidebar: Social Sticky */}
      <aside class="hidden lg:block lg:col-span-2">
        <div class="sticky top-32 flex flex-col gap-6 items-start py-12">
          <span
            class="text-[10px] font-black uppercase tracking-widest text-gray-400 dark:text-gray-500"
            >Share</span
          >
          <ShareButtons client:load title={story.headline} />
        </div>
      </aside>

      {/* Mobile Share Bar */}
      <div class="lg:hidden flex items-center justify-between py-6 border-b border-gray-100 dark:border-gray-800">
        <div class="flex items-center gap-3">
          <span class="text-[9px] font-black uppercase tracking-widest text-gray-400 dark:text-gray-500">Share</span>
          <ShareButtons client:load title={story.headline} />
        </div>
        <button class="flex items-center gap-2 text-[9px] font-black uppercase tracking-widest text-gray-400 dark:text-gray-300 bg-gray-50 dark:bg-gray-800 px-3 py-1.5 rounded-full border border-gray-100 dark:border-gray-700">
          <Bookmark className="w-3 h-3" />
          Save
        </button>
      </div>

      <section
        class="lg:col-span-8 lg:col-start-3 py-12 md:py-24 text-xl md:text-2xl font-serif leading-relaxed text-gray-900 dark:text-gray-200"
      >
        {
          blocks.map((block: any) => {
            if (block.type === "p") {
              return <p class="mb-8">{block.text}</p>;
            }
            if (block.type === "heading") {
              return (
                <h2 class="font-sans font-black text-3xl md:text-4xl text-black dark:text-white mt-16 mb-8 tracking-tight leading-none italic border-l-4 border-[#FAFF00] pl-6">
                  {block.text}
                </h2>
              );
            }
            if (block.type === "quote") {
              return (
                <blockquote class="my-12 border-l-4 border-gray-100 dark:border-gray-800 pl-8 font-serif text-3xl italic text-gray-500 dark:text-gray-400">
                  "{block.text}"
                  {block.author && (
                    <cite class="block text-xs font-black uppercase tracking-widest text-gray-400 dark:text-gray-500 mt-4 not-italic">
                      â€” {block.author}
                    </cite>
                  )}
                </blockquote>
              );
            }
            if (block.type === "image") {
              return (
                <figure class="my-12">
                  <img
                    src={block.url}
                    class="w-full h-auto rounded-3xl shadow-xl"
                  />
                  {block.caption && (
                    <figcaption class="mt-4 text-xs font-bold text-gray-400 dark:text-gray-500 text-center uppercase tracking-widest">
                      {block.caption}
                    </figcaption>
                  )}
                </figure>
              );
            }
            if (block.type === "callout") {
              return (
                <div class="bg-gray-50 dark:bg-gray-800/50 p-8 rounded-3xl border border-gray-100 dark:border-gray-800 my-12 transition-colors">
                  <h4 class="text-[10px] font-black uppercase tracking-[0.2em] text-[#FAFF00] mb-3">
                    {block.title || "Context"}
                  </h4>
                  <p class="text-xl font-bold text-black dark:text-white leading-tight">
                    {block.text}
                  </p>
                </div>
              );
            }
            if (block.type === "explained") {
              return (
                <div class="my-16 bg-black dark:bg-black/80 text-white p-8 md:p-12 rounded-[2.5rem] border-l-[12px] border-yellow-400 shadow-2xl relative overflow-hidden transition-colors">
                  <div class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -mr-32 -mt-32 blur-3xl" />
                  <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-8">
                      <div class="bg-yellow-400 p-2 rounded-lg text-black">
                        <CheckSquare className="w-5 h-5" />
                      </div>
                      <span class="text-xs font-black uppercase tracking-[0.3em] text-yellow-400">In a Nutshell</span>
                    </div>
                    <h3 class="text-3xl md:text-4xl font-serif-display font-black mb-8 tracking-tighter leading-none">
                      {block.title}
                    </h3>
                    <ul class="space-y-6">
                      {block.points?.map((point: string) => (
                        <li class="flex gap-4 items-start group">
                          <div class="w-2 h-2 rounded-full bg-yellow-400 mt-2.5 shrink-0 group-hover:scale-125 transition-transform" />
                          <p class="text-lg md:text-xl font-medium leading-relaxed text-gray-200">
                            {point}
                          </p>
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>
              );
            }
            if (block.type === "embed") {
              return <MultimediaEmbed url={block.url} />;
            }
            return null;
          })
        }
      </section>
    </div>

    <ScrollyIsland client:only="react" steps={steps} />
    <PersistentAudioPlayer client:load text={fullText} title={story.headline} />
  </div>
</MainLayout>
